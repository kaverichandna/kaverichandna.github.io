<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <title>Hutscape | Tutorials - BLE publish UV Index</title>
  

  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
  <link rel="canonical" href="http://localhost:4000/tutorials/ble-uvi" />
  <meta name="description" content="BLE publish UV Index">
  <meta property="og:locale" content="en_US" />
  <meta property="og:type" content="article" />
  <meta property="og:site_name" content="Hutscape"/>
  <meta property="og:type" content="article"/>
  <meta property="og:url" content="http://localhost:4000/tutorials/ble-uvi"/>
  <meta property="og:title" content="BLE publish UV Index"/>
  <meta property="og:description" content="BLE publish UV Index"/>
  

  <link rel="shortcut icon" href="http://localhost:4000/assets/favicon.ico"/>
  <link rel="icon" type="image/png" sizes="192x192" href="http://localhost:4000/assets/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="http://localhost:4000/assets/android-chrome-512x512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/assets/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="16x16" href="http://localhost:4000/assets/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="http://localhost:4000/assets/favicon-32x32.png">
  <link rel="manifest" href="http://localhost:4000/assets/site.webmanifest">

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.9.1/css/bulma.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/a11y-dark.min.css">
  <link href="//fonts.googleapis.com/css?family=Schoolbell&display=swap" rel="stylesheet">

  <style>
    .highlight { overflow: auto; margin: 24px 0;}
    figure.highlight { max-height: 600px; }
    .content figure { text-align: inherit; }

    .level { margin-bottom: 0 !important; }
    .handwriting { font-family: 'Schoolbell', cursive; transform: rotate(-5deg); margin: 0 0.5em; line-height: 1; }
  </style>

  

  
  <style>
    .video-container { position: relative; padding-bottom: 56.25%; padding-top: 30px; height: 0; overflow: hidden; }
    .video-container iframe, .video-container object, .video-container embed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .content img { display: block; margin: 30px; max-width: 800px; border: #efefef 20px solid; }
  </style>
  
</head>
<body>

<nav class="navbar is-spaced has-shadow" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item" href="/"> Hutscape </a>

    <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>

  <div id="navMenu" class="navbar-menu">
    <div class="navbar-start"><a class="navbar-item" href="/tutorials">Tutorials</a><a class="navbar-item" href="/checklists">Checklists</a><a class="navbar-item" href="/tools">Tools</a></div>

    <div class="navbar-end">
      <div class="navbar-item">
        <div class="buttons">
          <p class="handwriting has-text-grey-light">Spotted <br>a mistake?</p>
          <a class="button is-primary" href="https://github.com/hutscape/hutscape.github.io/blob/master/_tutorials/ble-uvi.md"><strong>Edit this page</strong></a>
          <a class="button is-light" href="https://github.com/hutscape/hutscape.github.io">
            <span class="icon">
              <i class="fab fa-github"></i>
            </span>
            <span>GitHub</span>
          </a>
          <a class="button is-light" href="https://www.youtube.com/@sayanee">
            <span class="icon">
              <i class="fab fa-youtube"></i>
            </span>
            <span>YouTube</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</nav>
<section class="section is-small">
  <div class="container">
    <h1 class="title is-1 has-background-info-light">BLE publish UV Index</h1>
    <div class="field is-grouped is-grouped-multiline">
      
      <div class="control">
        <div class="tags has-addons">
          <span class="tag is-light is-danger">dev board</span>
          <span class="tag is-light">Adafruit Feather Bluefruit</span>
        </div>
      </div>
      

      

      
      
      <div class="control">
        <div class="tags has-addons">
          <span class="tag is-light is-warning">chip</span>
          <span class="tag is-light">VEML6075</span>
        </div>
      </div>
      
      <div class="control">
        <div class="tags has-addons">
          <span class="tag is-light is-warning">chip</span>
          <span class="tag is-light">nRF52</span>
        </div>
      </div>
      
      

      

      
      
      <div class="control">
        <div class="tags has-addons">
          <span class="tag is-light is-info">sensor</span>
          <span class="tag is-light">UV Index</span>
        </div>
      </div>
      
      

      
      <div class="control">
        <div class="tags has-addons">
          <span class="tag is-light is-success">features</span>
          
          <span class="tag is-light">BLE</span>
          
          <span class="tag is-light">GATT</span>
          
        </div>
      </div>
      

      
    </div>
    <hr>

    
    <h2 class="title is-2">Before starting</h2>
    

    <div class="columns is-desktop">
      
      <div class="column">
        <div class="card">
          <header class="card-header">
            <p class="card-header-title">Dependancies</p>
          </header>

          <div class="card-content">
            <div class="content">Ensure the following dependancies are downloaded and available:</div>
            <div class="content">
              <ul>
                
                <li><a href="https://github.com/adafruit/Adafruit_nRF52_Arduino">Adafruit nRF52 Arduino</a></li>
                
                <li><a href="https://apps.apple.com/sg/app/nrf-connect/id1054362403">nRF Connect iPhone app</a></li>
                
              </ul>
            </div>
          </div>
        </div>
      </div>
      

      

      
      <div class="column">
        <div class="card">
          <header class="card-header">
            <p class="card-header-title">Buy the components</p>
          </header>

          <div class="card-content">
            <div class="content">
              <ol>
                
                <li><a href="https://amzn.to/39WpHw8">Adafruit Feather Bluefruit nRF52</a></li>
                
              </ol>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</section>

<section class="section is-small">
  <div class="container">
    <h2 class="title is-2">Code</h2>
    

    
      <!-- For Arduino INO file code examples -->
      <a href="https://github.com/hutscape/hutscape.github.io/tree/master/_tutorials/code/ble-uvi" class="button is-primary">Download code</a>
      <code class="is-size-4">ble-uvi.ino</code>
      
<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;bluefruit.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"Adafruit_VEML6075.h"</span><span class="cp">
</span>
<span class="cm">/* GATT Services https://www.bluetooth.com/specifications/gatt/services/
    Name: Environmental Sensing
    Uniform Type Identifier: org.bluetooth.service.environmental_sensing
    Assigned Number: 0x181A
    Specification: GSS
*/</span>
<span class="cp">#define UUID16_SVC_ENVIRONMENTAL_SENSING 0x181A
</span>
<span class="cm">/* GATT Characteristics https://www.bluetooth.com/specifications/gatt/characteristics/
    Name: UV Index
    Uniform Type Identifier: org.bluetooth.characteristic.uv_index
    Assigned Number: 0x2A76
    Specification: GSS
*/</span>
<span class="cp">#define UUID16_CHR_UV_INDEX 0x2A76
</span>
<span class="n">BLEService</span>        <span class="n">ess</span> <span class="o">=</span> <span class="n">BLEService</span><span class="p">(</span><span class="n">UUID16_SVC_ENVIRONMENTAL_SENSING</span><span class="p">);</span>
<span class="n">BLECharacteristic</span> <span class="n">uvic</span> <span class="o">=</span> <span class="n">BLECharacteristic</span><span class="p">(</span><span class="n">UUID16_CHR_UV_INDEX</span><span class="p">);</span>

<span class="n">BLEDis</span> <span class="n">bledis</span><span class="p">;</span>    <span class="c1">// DIS (Device Information Service) helper class instance</span>

<span class="n">Adafruit_VEML6075</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">Adafruit_VEML6075</span><span class="p">();</span>

<span class="c1">// See https://www.bluetooth.com/wp-content/uploads/Sitecore-Media-Library/Gatt/Xml/Characteristics/org.bluetooth.characteristic.uv_index.xml</span>

<span class="c1">// UV index GATT Characteristic format is in uint8</span>
<span class="kt">uint8_t</span>  <span class="n">uvindexvalue</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">;</span>

<span class="c1">// VEML6075 UV sensor reading is in float</span>
<span class="kt">float</span>  <span class="n">readUVIndexValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="c1">// Advanced function prototypes</span>
<span class="kt">void</span> <span class="nf">startAdv</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">setupESService</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">connect_callback</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">conn_handle</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">disconnect_callback</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">conn_handle</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">reason</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">)</span> <span class="n">delay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>   <span class="c1">// for nrf52840 with native usb</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Bluefruit52 UV Index sensor example"</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"-------------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

  <span class="c1">// Initialise UV sensor VEML6075</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uv</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Failed to communicate with VEML6075 sensor, check wiring?"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Initialise the Bluefruit module</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Initialise the Bluefruit nRF52 module"</span><span class="p">);</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="s">"Bluefruit52"</span><span class="p">);</span>

  <span class="c1">// Set the connect/disconnect callback handlers</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Periph</span><span class="p">.</span><span class="n">setConnectCallback</span><span class="p">(</span><span class="n">connect_callback</span><span class="p">);</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Periph</span><span class="p">.</span><span class="n">setDisconnectCallback</span><span class="p">(</span><span class="n">disconnect_callback</span><span class="p">);</span>

  <span class="c1">// Configure and Start the Device Information Service</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Configuring the Device Information Service"</span><span class="p">);</span>
  <span class="n">bledis</span><span class="p">.</span><span class="n">setManufacturer</span><span class="p">(</span><span class="s">"Adafruit Industries"</span><span class="p">);</span>
  <span class="n">bledis</span><span class="p">.</span><span class="n">setModel</span><span class="p">(</span><span class="s">"Bluefruit Feather52"</span><span class="p">);</span>
  <span class="n">bledis</span><span class="p">.</span><span class="n">begin</span><span class="p">();;</span>

  <span class="c1">// Setup the Environmental Sensing service using</span>
  <span class="c1">// BLEService and BLECharacteristic classes</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Configuring the Environmental Sensing Service"</span><span class="p">);</span>
  <span class="n">setupESService</span><span class="p">();</span>

  <span class="c1">// Setup the advertising packet(s)</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Setting up the advertising payload(s)"</span><span class="p">);</span>
  <span class="n">startAdv</span><span class="p">();</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Advertising"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">digitalToggle</span><span class="p">(</span><span class="n">LED_RED</span><span class="p">);</span>

  <span class="n">readUVIndexValue</span> <span class="o">=</span> <span class="n">uv</span><span class="p">.</span><span class="n">readUVI</span><span class="p">();</span>
  <span class="n">uvindexvalue</span> <span class="o">=</span> <span class="n">round</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">readUVIndexValue</span><span class="p">));</span>  <span class="c1">// convert float to uint8_t</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Raw UV Index (float): "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">readUVIndexValue</span><span class="p">);</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Raw UV Index (uint8_t): "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">uvindexvalue</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Bluefruit</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Note: We use .indicate instead of .write!</span>
    <span class="c1">// If it is connected but CCCD is not enabled</span>
    <span class="c1">// The characteristic's value is still updated although indicate is not sent</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uvic</span><span class="p">.</span><span class="n">indicate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvindexvalue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uvindexvalue</span><span class="p">)))</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"UV Index Measurement updated to: "</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">uvindexvalue</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"ERROR: Indicate not set in the CCCD or not connected!"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">startAdv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Advertising packet</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Advertising</span><span class="p">.</span><span class="n">addFlags</span><span class="p">(</span><span class="n">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="p">);</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Advertising</span><span class="p">.</span><span class="n">addTxPower</span><span class="p">();</span>

  <span class="c1">// Include HTM Service UUID</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Advertising</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="n">ess</span><span class="p">);</span>

  <span class="c1">// Include Name</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Advertising</span><span class="p">.</span><span class="n">addName</span><span class="p">();</span>

  <span class="cm">/* Start Advertising
   * - Enable auto advertising if disconnected
   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms
   * - Timeout for fast mode is 30 seconds
   * - Start(timeout) with timeout = 0 will advertise forever (until connected)
   *
   * For recommended advertising interval
   * https://developer.apple.com/library/content/qa/qa1931/_index.html
   */</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Advertising</span><span class="p">.</span><span class="n">restartOnDisconnect</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

  <span class="c1">// in unit of 0.625 ms</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Advertising</span><span class="p">.</span><span class="n">setInterval</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">244</span><span class="p">);</span>

  <span class="c1">// number of seconds in fast mode</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Advertising</span><span class="p">.</span><span class="n">setFastTimeout</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

  <span class="c1">// 0 = Don't stop advertising after n seconds</span>
  <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Advertising</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setupESService</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Configure the Environmental Sensing service</span>
  <span class="c1">// See: https://www.bluetooth.com/wp-content/uploads/Sitecore-Media-Library/Gatt/Xml/Characteristics/org.bluetooth.characteristic.uv_index.xml</span>
  <span class="c1">// Supported Characteristics:</span>
  <span class="c1">// Name                         UUID    Requirement Properties</span>
  <span class="c1">// ---------------------------- ------  ----------- ----------</span>
  <span class="c1">// UV Index                     0x2A76  Mandatory   Read</span>
  <span class="n">ess</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>

  <span class="c1">// Note: You must call .begin() on the BLEService before calling .begin() on</span>
  <span class="c1">// any characteristic(s) within that service definition.. Calling .begin() on</span>
  <span class="c1">// a BLECharacteristic will cause it to be added to the last BLEService that</span>
  <span class="c1">// was 'begin()'ed!</span>

  <span class="c1">// Configure the UV Index characteristic</span>
  <span class="c1">// See:https://www.bluetooth.com/wp-content/uploads/Sitecore-Media-Library/Gatt/Xml/Characteristics/org.bluetooth.characteristic.uv_index.xml</span>
  <span class="c1">// Properties = Indicate</span>
  <span class="c1">// Min Len    = 1</span>
  <span class="c1">// Max Len    = 1</span>
  <span class="c1">// B0         = UINT8 - UV Index measurement unitless</span>
  <span class="n">uvic</span><span class="p">.</span><span class="n">setProperties</span><span class="p">(</span><span class="n">CHR_PROPS_INDICATE</span><span class="p">);</span>
  <span class="n">uvic</span><span class="p">.</span><span class="n">setPermission</span><span class="p">(</span><span class="n">SECMODE_OPEN</span><span class="p">,</span> <span class="n">SECMODE_NO_ACCESS</span><span class="p">);</span>
  <span class="n">uvic</span><span class="p">.</span><span class="n">setFixedLen</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">uvic</span><span class="p">.</span><span class="n">setCccdWriteCallback</span><span class="p">(</span><span class="n">cccd_callback</span><span class="p">);</span>  <span class="c1">// Optionally capture CCCD updates</span>
  <span class="n">uvic</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="n">uvic</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvindexvalue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uvindexvalue</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">connect_callback</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">conn_handle</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Get the reference to current connection</span>
  <span class="n">BLEConnection</span><span class="o">*</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">Bluefruit</span><span class="p">.</span><span class="n">Connection</span><span class="p">(</span><span class="n">conn_handle</span><span class="p">);</span>

  <span class="kt">char</span> <span class="n">central_name</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="n">connection</span><span class="o">-&gt;</span><span class="n">getPeerName</span><span class="p">(</span><span class="n">central_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">central_name</span><span class="p">));</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Connected to "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">central_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**
 * Callback invoked when a connection is dropped
 * @param conn_handle connection where this event happens
 * @param reason is a BLE_HCI_STATUS_CODE which can be found in ble_hci.h
 */</span>
<span class="kt">void</span> <span class="nf">disconnect_callback</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">conn_handle</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">conn_handle</span><span class="p">;</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">reason</span><span class="p">;</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Disconnected"</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Advertising!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cccd_callback</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">conn_hdl</span><span class="p">,</span>
  <span class="n">BLECharacteristic</span><span class="o">*</span> <span class="n">chr</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">cccd_value</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Display the raw request packet</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"CCCD Updated: "</span><span class="p">);</span>

    <span class="c1">// Serial.printBuffer(request-&gt;data, request-&gt;len);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">cccd_value</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>

    <span class="c1">// Check the characteristic this CCCD update is associated with in case</span>
    <span class="c1">// this handler is used for multiple CCCD records.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">chr</span><span class="o">-&gt;</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">uvic</span><span class="p">.</span><span class="n">uuid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chr</span><span class="o">-&gt;</span><span class="n">indicateEnabled</span><span class="p">(</span><span class="n">conn_hdl</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"UV Index Measurement 'Indicate' enabled"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"UV Index Measurement 'Indicate' disabled"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>


      <h2 class="title is-2">Makefile</h2>
      
<figure class="highlight"><pre><code class="language-make" data-lang="make"><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">lint compile upload clean</span>

<span class="nl">lint</span><span class="o">:</span>
	cpplint <span class="nt">--extensions</span><span class="o">=</span>ino <span class="nt">--filter</span><span class="o">=</span><span class="nt">-legal</span>/copyright <span class="k">*</span>.ino

<span class="nl">compile</span><span class="o">:</span>
	arduino-cli compile <span class="nt">--fqbn</span> adafruit:nrf52:feather52832 ./

<span class="nl">upload</span><span class="o">:</span>
	adafruit-nrfutil dfu genpkg <span class="nt">--dev-type</span> 0x0052 <span class="nt">--application</span> ./.<span class="k">*</span>.hex dfu-package.zip
	adafruit-nrfutil dfu serial <span class="nt">--package</span> dfu-package.zip <span class="nt">-p</span> /dev/tty.SLAB_USBtoUART <span class="nt">-b</span> 115200

<span class="nl">clean</span><span class="o">:</span>
	<span class="nb">rm</span> <span class="nt">-f</span> .<span class="k">*</span>.bin
	<span class="nb">rm</span> <span class="nt">-f</span> .<span class="k">*</span>.elf
	<span class="nb">rm</span> <span class="nt">-f</span> .<span class="k">*</span>.hex
	<span class="nb">rm</span> <span class="nt">-f</span> <span class="k">*</span>.zip

<span class="nl">flash</span><span class="o">:</span> <span class="nf">lint compile upload clean</span></code></pre></figure>

    
  </div>
</section>


<section class="section is-small">
  <div class="container">
    <div class="columns is-multiline is-desktop">
      

      
      <div class="column is-half">
        <h2 class="title is-2">Schematic</h2>
        <p class="subtitle is-4">Wire up the hardware accordingly</p>
        <a href="/assets/images/tutorials/ble-uvi-schematic.png"><img
            src="/assets/images/tutorials/ble-uvi-schematic.png" alt="BLE publish UV Index schematic"></a>
      </div>
      

      

      
      <div class="column is-half">
        <h2 class="title is-2">Serial console</h2>
        <p class="subtitle is-4">Serial output from the firmware.</p>
        <a href="/assets/images/tutorials/ble-uvi-console.jpg"><img
            src="/assets/images/tutorials/ble-uvi-console.jpg" alt="BLE publish UV Index serial console"></a>
      </div>
      

      
    </div>
  </div>
</section>



<section class="section is-small">
  <div class="container">
    <div class="content is-medium">
      <h2 class="title is-2">Description</h2>
      <p>Publish a UV Index value via BLE and view it on iPhone app nRF Connect.</p>

<p>UV Index <a href="https://www.bluetooth.com/wp-content/uploads/Sitecore-Media-Library/Gatt/Xml/Characteristics/org.bluetooth.characteristic.uv_index.xml">GATT Characteristics</a>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Copyright 2014 Bluetooth SIG, Inc. All rights reserved. --&gt;</span>
<span class="nt">&lt;Characteristic</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"http://schemas.bluetooth.org/Documents/characteristic.xsd"</span> <span class="na">name=</span><span class="s">"UV Index"</span> <span class="na">type=</span><span class="s">"org.bluetooth.characteristic.uv_index"</span> <span class="na">uuid=</span><span class="s">"2A76"</span> <span class="na">last-modified=</span><span class="s">"2014-11-20"</span> <span class="na">approved=</span><span class="s">"Yes"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Value&gt;</span>
    <span class="nt">&lt;Field</span> <span class="na">name=</span><span class="s">"UV Index"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Requirement&gt;</span>Mandatory<span class="nt">&lt;/Requirement&gt;</span>
      <span class="nt">&lt;Format&gt;</span>uint8<span class="nt">&lt;/Format&gt;</span>
      <span class="nt">&lt;Unit&gt;</span>org.bluetooth.unit.unitless<span class="nt">&lt;/Unit&gt;</span>
      <span class="nt">&lt;DecimalExponent&gt;</span>0<span class="nt">&lt;/DecimalExponent&gt;</span>
    <span class="nt">&lt;/Field&gt;</span>
  <span class="nt">&lt;/Value&gt;</span>
<span class="nt">&lt;/Characteristic&gt;</span>
</code></pre></div></div>

<p>Use the nRF Connect iPhone app to view the UV Index values.</p>

<p><img src="http://localhost:4000/assets/images/tutorials/ble-uvi-nrf-connect.jpg" alt="" />
<img src="http://localhost:4000/assets/images/tutorials/ble-uvi-nrf-connect-services.jpg" alt="" />
<img src="http://localhost:4000/assets/images/tutorials/ble-uvi-nrf-connect-char.jpg" alt="" />
<img src="http://localhost:4000/assets/images/tutorials/ble-uvi-nrf-connect-char-read.jpg" alt="" /></p>

    </div>
  </div>
</section>

<section class="section is-small">
  <div class="container">
    <h2 class="title is-2">References</h2>

    <div class="content">
      <ol>
        
        <li id="footnote-1"><a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/custom_htm/custom_htm.ino">Code reference</a></li>
        
        <li id="footnote-2"><a href="https://www.bluetooth.com/specifications/gatt/services">Bluetooth GATT service</a></li>
        
        <li id="footnote-3"><a href="https://www.bluetooth.com/specifications/gatt/characteristics">Bluetooth GATT characteristics</a></li>
        
        <li id="footnote-4"><a href="https://itunes.apple.com/sg/app/nrf-connect/id1054362403?mt=8">Download iPhone nRF connect</a></li>
        
        <li id="footnote-5"><a href="https://github.com/NordicSemiconductor/IOS-nRF-Toolbox">nRF Toolbox iOS app source code</a></li>
        
        <li id="footnote-6"><a href="https://www.bluetooth.com/wp-content/uploads/Sitecore-Media-Library/Gatt/Xml/Characteristics/org.bluetooth.characteristic.uv_index.xml">BLE Assigned number for Environmental Sensing Service for UV Index characteristics</a></li>
        
      </ol>
    </div>
  </div>
</section>


<footer class="footer">
  <div class="content has-text-centered">
    <p>
      <a property="dct:title" rel="cc:attributionURL" href="https://hutscape.com">Hutscape</a> © 2022 by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="https://sayan.ee">Sayanee Basu</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY 4.0</a>
      <br>
      The source code is licensed <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.
      <br>
      <a href="https://www.flaticon.com/free-icon/home_6675253?related_id=6675253&origin=tag" title="house icons">House logo</a> created by smashingstocks, Flaticon </a>
    </p>
  </div>
</footer>
<!-- Scripts --><script>
document.addEventListener('DOMContentLoaded', () => {
  const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

  if ($navbarBurgers.length > 0) {
    $navbarBurgers.forEach( el => {
      el.addEventListener('click', () => {
        const target = el.dataset.target;
        console.log(target)
        const $target = document.getElementById(target);
        el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  }
});
</script>
<script src="//use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.js"></script>
<script>anchors.add()</script>

</body>
</html>
